"""–ù–∞—Å—Ç—Ä–æ–π–∫–∞ middleware –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è FastAPI.–°–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤—Å–µ—Ö middleware –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:CORS, —Å–∂–∞—Ç–∏–µ, —Å–µ—Å—Å–∏–∏, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –∫–∞—Å—Ç–æ–º–Ω—ã–µ middleware."""import loggingimport timeimport uuidfrom typing import Callablefrom fastapi import FastAPI, Request, Responsefrom fastapi.middleware.cors import CORSMiddlewarefrom fastapi.middleware.trustedhost import TrustedHostMiddlewarefrom starlette.middleware.base import BaseHTTPMiddlewarefrom starlette.middleware.gzip import GZipMiddlewarefrom starlette.middleware.sessions import SessionMiddlewarefrom starlette.types import ASGIAppfrom app.core.config import settingslogger = logging.getLogger(__name__)class RequestLoggingMiddleware(BaseHTTPMiddleware):    """    Middleware –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤.    –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ –≤–∫–ª—é—á–∞—è:    - –ú–µ—Ç–æ–¥ –∏ –ø—É—Ç—å    - –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è    - –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞    - IP –∞–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞    - User Agent    """    async def dispatch(self, request: Request, call_next: Callable) -> Response:        """        –û–±—Ä–∞–±–æ—Ç–∫–∞ HTTP –∑–∞–ø—Ä–æ—Å–∞ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º.        Args:            request: –í—Ö–æ–¥—è—â–∏–π HTTP –∑–∞–ø—Ä–æ—Å            call_next: –°–ª–µ–¥—É—é—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤ —Ü–µ–ø–æ—á–∫–µ        Returns:            Response: HTTP –æ—Ç–≤–µ—Ç        """        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∑–∞–ø—Ä–æ—Å–∞        request_id = str(uuid.uuid4())[:8]        # –î–æ–±–∞–≤–ª—è–µ–º ID –∑–∞–ø—Ä–æ—Å–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç        request.state.request_id = request_id        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∏–µ–Ω—Ç–µ        client_ip = self._get_client_ip(request)        user_agent = request.headers.get("user-agent", "Unknown")        # –ó–∞—Å–µ–∫–∞–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞        start_time = time.time()        logger.info(            f"[{request_id}] {request.method} {request.url.path} - "            f"Client: {client_ip} - "            f"User-Agent: {user_agent[:100]}..."        )        try:            # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å            response = await call_next(request)            # –í—ã—á–∏—Å–ª—è–µ–º –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è            process_time = time.time() - start_time            # –õ–æ–≥–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç            logger.info(                f"[{request_id}] {request.method} {request.url.path} - "                f"Status: {response.status_code} - "                f"Time: {process_time:.4f}s - "                f"Size: {response.headers.get('content-length', 'unknown')} bytes"            )            # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞            response.headers["X-Request-ID"] = request_id            response.headers["X-Process-Time"] = f"{process_time:.4f}"            return response        except Exception as e:            # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏            process_time = time.time() - start_time            logger.error(                f"[{request_id}] {request.method} {request.url.path} - "                f"ERROR: {str(e)} - "                f"Time: {process_time:.4f}s"            )            raise    def _get_client_ip(self, request: Request) -> str:        """        –ü–æ–ª—É—á–µ–Ω–∏–µ IP –∞–¥—Ä–µ—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞ —Å —É—á–µ—Ç–æ–º –ø—Ä–æ–∫—Å–∏.        Args:            request: HTTP –∑–∞–ø—Ä–æ—Å        Returns:            str: IP –∞–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞        """        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –ø—Ä–æ–∫—Å–∏        forwarded_for = request.headers.get("x-forwarded-for")        if forwarded_for:            # –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π IP –∏–∑ —Å–ø–∏—Å–∫–∞            return forwarded_for.split(",")[0].strip()        real_ip = request.headers.get("x-real-ip")        if real_ip:            return real_ip        # Fallback –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π IP        if request.client:            return request.client.host        return "unknown"class SecurityHeadersMiddleware(BaseHTTPMiddleware):    """    Middleware –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.    –î–æ–±–∞–≤–ª—è–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç    —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∞—Ç–∞–∫ –∏ –ø–æ–≤—ã—à–µ–Ω–∏—è –æ–±—â–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.    """    async def dispatch(self, request: Request, call_next: Callable) -> Response:        """        –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∫ –æ—Ç–≤–µ—Ç—É.        Args:            request: HTTP –∑–∞–ø—Ä–æ—Å            call_next: –°–ª–µ–¥—É—é—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫        Returns:            Response: HTTP –æ—Ç–≤–µ—Ç —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏        """        response = await call_next(request)        # –ó–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏        security_headers = {            # –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç MIME type sniffing            "X-Content-Type-Options": "nosniff",            # –ó–∞—â–∏—Ç–∞ –æ—Ç XSS            "X-XSS-Protection": "1; mode=block",            # –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É –≤ iframe (clickjacking)            "X-Frame-Options": "DENY",            # –£–¥–∞–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Ä–≤–µ—Ä–µ            "Server": "Gemup-API",            # Referrer Policy            "Referrer-Policy": "strict-origin-when-cross-origin"        }        # Content Security Policy (—Ç–æ–ª—å–∫–æ –¥–ª—è HTML –æ—Ç–≤–µ—Ç–æ–≤)        if response.headers.get("content-type", "").startswith("text/html"):            security_headers["Content-Security-Policy"] = (                "default-src 'self'; "                "script-src 'self' 'unsafe-inline'; "                "style-src 'self' 'unsafe-inline'; "                "img-src 'self' data: https:; "                "connect-src 'self';"            )        # HSTS –¥–ª—è HTTPS (—Ç–æ–ª—å–∫–æ –≤ production)        if settings.is_production() and request.url.scheme == "https":            security_headers["Strict-Transport-Security"] = (                "max-age=31536000; includeSubDomains; preload"            )        # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∫ –æ—Ç–≤–µ—Ç—É        for header, value in security_headers.items():            response.headers[header] = value        return responseclass RateLimitMiddleware(BaseHTTPMiddleware):    """    Middleware –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤.    –†–µ–∞–ª–∏–∑—É–µ—Ç –±–∞–∑–æ–≤–æ–µ rate limiting –Ω–∞ –æ—Å–Ω–æ–≤–µ IP –∞–¥—Ä–µ—Å–æ–≤    —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Redis –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤.    """    def __init__(self, app: ASGIApp, requests_per_minute: int = 60):        """        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è middleware.        Args:            app: ASGI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ            requests_per_minute: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É        """        super().__init__(app)        self.requests_per_minute = requests_per_minute    async def dispatch(self, request: Request, call_next: Callable) -> Response:        """        –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤.        Args:            request: HTTP –∑–∞–ø—Ä–æ—Å            call_next: –°–ª–µ–¥—É—é—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫        Returns:            Response: HTTP –æ—Ç–≤–µ—Ç –∏–ª–∏ –æ—à–∏–±–∫–∞ 429        """        from app.core.redis import redis_client        from fastapi import status        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º rate limiting –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –ø—É—Ç–µ–π        excluded_paths = ["/health", "/metrics", "/docs", "/redoc", "/openapi.json"]        if any(request.url.path.startswith(path) for path in excluded_paths):            return await call_next(request)        # –ü–æ–ª—É—á–∞–µ–º –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–ª–∏–µ–Ω—Ç–∞        client_ip = self._get_client_ip(request)        try:            # –ü—Ä–æ–≤–µ—Ä—è–µ–º rate limit —á–µ—Ä–µ–∑ Redis            allowed = await redis_client.rate_limit_check(                identifier=f"rate_limit:{client_ip}",                limit=self.requests_per_minute,                window_seconds=60            )            if not allowed:                logger.warning(f"Rate limit exceeded for IP: {client_ip}")                # –°–æ–∑–¥–∞–µ–º –æ—Ç–≤–µ—Ç 429                from fastapi.responses import JSONResponse                return JSONResponse(                    status_code=status.HTTP_429_TOO_MANY_REQUESTS,                    content={                        "error": True,                        "message": "Rate limit exceeded",                        "code": "RATE_LIMIT_ERROR",                        "retry_after": 60                    },                    headers={"Retry-After": "60"}                )        except Exception as e:            # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ Redis —Ä–∞–∑—Ä–µ—à–∞–µ–º –∑–∞–ø—Ä–æ—Å            logger.error(f"Rate limit check failed: {e}")        return await call_next(request)    def _get_client_ip(self, request: Request) -> str:        """–ü–æ–ª—É—á–µ–Ω–∏–µ IP –∞–¥—Ä–µ—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞."""        forwarded_for = request.headers.get("x-forwarded-for")        if forwarded_for:            return forwarded_for.split(",")[0].strip()        if request.client:            return request.client.host        return "unknown"def setup_middleware(app: FastAPI) -> None:    """    –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—Å–µ—Ö middleware –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è FastAPI.    –ü–æ—Ä—è–¥–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è middleware –≤–∞–∂–µ–Ω - –æ–Ω–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ.    Args:        app: –≠–∫–∑–µ–º–ø–ª—è—Ä FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è    """    logger.info("Setting up middleware...")    # 1. CORS middleware (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–≤—ã–º)    app.add_middleware(        CORSMiddleware,        allow_origins=settings.cors_origins_list,        allow_credentials=True,        allow_methods=["GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS", "HEAD"],        allow_headers=["*"],        expose_headers=["X-Request-ID", "X-Process-Time"]    )    logger.info("‚úÖ CORS middleware configured")    # 2. Trusted Host middleware (—Ç–æ–ª—å–∫–æ –≤ production)    if settings.is_production():        # –í production —É–∫–∞–∂–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–æ–º–µ–Ω—ã        allowed_hosts = [            "api.gemup.com",            "*.gemup.com",            "gemup.com"        ]        app.add_middleware(            TrustedHostMiddleware,            allowed_hosts=allowed_hosts        )        logger.info("‚úÖ Trusted Host middleware configured for production")    # 3. Security Headers middleware    app.add_middleware(SecurityHeadersMiddleware)    logger.info("‚úÖ Security Headers middleware configured")    # 4. GZip compression middleware    app.add_middleware(        GZipMiddleware,        minimum_size=1000,  # –°–∂–∏–º–∞—Ç—å –æ—Ç–≤–µ—Ç—ã –±–æ–ª—å—à–µ 1KB        compresslevel=6  # –£—Ä–æ–≤–µ–Ω—å —Å–∂–∞—Ç–∏—è (1-9)    )    logger.info("‚úÖ GZip middleware configured")    # 5. Session middleware    app.add_middleware(        SessionMiddleware,        secret_key=settings.secret_key,        max_age=settings.cache_session_ttl,        same_site="lax",        https_only=settings.is_production()    )    logger.info("‚úÖ Session middleware configured")    # 6. Rate Limiting middleware (—Ç–æ–ª—å–∫–æ –≤ production)    if settings.is_production():        app.add_middleware(            RateLimitMiddleware,            requests_per_minute=settings.rate_limit_requests        )        logger.info("‚úÖ Rate Limiting middleware configured")    # 7. Request Logging middleware (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–º)    app.add_middleware(RequestLoggingMiddleware)    logger.info("‚úÖ Request Logging middleware configured")    logger.info("üöÄ All middleware configured successfully")def setup_error_handlers(app: FastAPI) -> None:    """    –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –æ—à–∏–±–æ–∫.    Args:        app: –≠–∫–∑–µ–º–ø–ª—è—Ä FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è    """    from app.core.exceptions import setup_exception_handlers    setup_exception_handlers(app)    logger.info("‚úÖ Error handlers configured")def add_custom_middleware(app: FastAPI, middleware_class, **kwargs) -> None:    """    –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ middleware.    Args:        app: –≠–∫–∑–µ–º–ø–ª—è—Ä FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è        middleware_class: –ö–ª–∞—Å—Å middleware        **kwargs: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã    """    app.add_middleware(middleware_class, **kwargs)    logger.info(f"‚úÖ Custom middleware {middleware_class.__name__} added")# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ utility —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è middlewaredef get_request_id(request: Request) -> str:    """    –ü–æ–ª—É—á–µ–Ω–∏–µ ID –∑–∞–ø—Ä–æ—Å–∞ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞.    Args:        request: HTTP –∑–∞–ø—Ä–æ—Å    Returns:        str: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∑–∞–ø—Ä–æ—Å–∞    """    return getattr(request.state, "request_id", "unknown")def is_health_check(request: Request) -> bool:    """    –ü—Ä–æ–≤–µ—Ä–∫–∞ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∑–∞–ø—Ä–æ—Å health check.    Args:        request: HTTP –∑–∞–ø—Ä–æ—Å    Returns:        bool: True –µ—Å–ª–∏ —ç—Ç–æ health check    """    health_paths = ["/health", "/healthz", "/status", "/ping"]    return request.url.path in health_pathsdef is_static_file(request: Request) -> bool:    """    –ü—Ä–æ–≤–µ—Ä–∫–∞ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∑–∞–ø—Ä–æ—Å –∫ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–º—É —Ñ–∞–π–ª—É.    Args:        request: HTTP –∑–∞–ø—Ä–æ—Å    Returns:        bool: True –µ—Å–ª–∏ —ç—Ç–æ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Ñ–∞–π–ª    """    static_extensions = [".css", ".js", ".png", ".jpg", ".jpeg", ".gif", ".ico", ".svg"]    return any(request.url.path.endswith(ext) for ext in static_extensions)def get_user_agent_info(request: Request) -> dict:    """    –ü–∞—Ä—Å–∏–Ω–≥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ User-Agent.    Args:        request: HTTP –∑–∞–ø—Ä–æ—Å    Returns:        dict: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—Ä–∞—É–∑–µ—Ä–µ –∏ –û–°    """    user_agent = request.headers.get("user-agent", "")    # –ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–∏–Ω–≥ (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É user-agents –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ)    info = {        "full": user_agent,        "is_mobile": "Mobile" in user_agent or "Android" in user_agent,        "is_bot": any(bot in user_agent.lower() for bot in ["bot", "crawler", "spider"]),        "browser": "unknown",        "os": "unknown"    }    # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞    if "Chrome" in user_agent:        info["browser"] = "Chrome"    elif "Firefox" in user_agent:        info["browser"] = "Firefox"    elif "Safari" in user_agent:        info["browser"] = "Safari"    elif "Edge" in user_agent:        info["browser"] = "Edge"    # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –û–°    if "Windows" in user_agent:        info["os"] = "Windows"    elif "Mac" in user_agent:        info["os"] = "macOS"    elif "Linux" in user_agent:        info["os"] = "Linux"    elif "Android" in user_agent:        info["os"] = "Android"    elif "iOS" in user_agent:        info["os"] = "iOS"    return info