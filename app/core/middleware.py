"""–ù–∞—Å—Ç—Ä–æ–π–∫–∞ middleware –¥–ª—è FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.–í–∫–ª—é—á–∞–µ—Ç CORS, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, —Å–∂–∞—Ç–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫."""import loggingimport timeimport uuidfrom fastapi import FastAPI, Requestfrom fastapi.middleware.cors import CORSMiddlewarefrom fastapi.middleware.gzip import GZipMiddlewarefrom fastapi.responses import JSONResponsefrom starlette.middleware.base import BaseHTTPMiddlewarefrom starlette.middleware.sessions import SessionMiddlewarefrom app.core.config import settingslogger = logging.getLogger(__name__)class SecurityHeadersMiddleware(BaseHTTPMiddleware):    """    Middleware –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.    –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –≤–∞–∂–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∫–æ –≤—Å–µ–º –æ—Ç–≤–µ—Ç–∞–º,    —Å –æ—Å–æ–±–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ API.    """    def __init__(self, app, **kwargs):        super().__init__(app, **kwargs)        # –ë–∞–∑–æ–≤—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü)        self.base_headers = {            "X-Content-Type-Options": "nosniff",            "X-XSS-Protection": "1; mode=block",            "X-Frame-Options": "DENY",            "Server": "Gemup-API",            "Referrer-Policy": "strict-origin-when-cross-origin",        }        # –°—Ç—Ä–æ–≥–∏–π CSP –¥–ª—è API —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤        self.api_csp = (            "default-src 'self'; "            "script-src 'self' 'unsafe-inline'; "            "style-src 'self' 'unsafe-inline'; "            "img-src 'self' data: https:; "            "connect-src 'self';"        )        # –ë–æ–ª–µ–µ –º—è–≥–∫–∏–π CSP –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ (—Ä–∞–∑—Ä–µ—à–∞–µ–º CDN)        self.docs_csp = (            "default-src 'self' https:; "            "script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com; "            "style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com; "            "img-src 'self' data: https:; "            "connect-src 'self' https:; "            "font-src 'self' https://cdn.jsdelivr.net https://unpkg.com;"        )    async def dispatch(self, request: Request, call_next):        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏."""        # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è        response = await call_next(request)        # –î–æ–±–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏        for header, value in self.base_headers.items():            response.headers[header] = value        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º CSP –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—É—Ç–∏        path = request.url.path        if path in ["/docs", "/redoc"] or path.startswith("/docs/") or path.startswith("/redoc/"):            # –î–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –º—è–≥–∫–∏–π CSP (—Ä–∞–∑—Ä–µ—à–∞–µ–º CDN)            response.headers["Content-Security-Policy"] = self.docs_csp            logger.debug(f"Applied docs CSP for path: {path}")        else:            # –î–ª—è API –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–≥–∏–π CSP            response.headers["Content-Security-Policy"] = self.api_csp        # –î–æ–±–∞–≤–ª—è–µ–º HSTS —Ç–æ–ª—å–∫–æ –≤ production —Å HTTPS        if settings.is_production():            response.headers["Strict-Transport-Security"] = "max-age=31536000; includeSubDomains; preload"        return responseclass RequestLoggingMiddleware(BaseHTTPMiddleware):    """    Middleware –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤.    –õ–æ–≥–∏—Ä—É–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ –≤–∫–ª—é—á–∞—è –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏,    —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞, —Ä–∞–∑–º–µ—Ä –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞.    """    def __init__(self, app, **kwargs):        super().__init__(app, **kwargs)        self.exclude_paths = {"/health", "/metrics", "/favicon.ico"}    async def dispatch(self, request: Request, call_next):        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞."""        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∑–∞–ø—Ä–æ—Å–∞        request_id = str(uuid.uuid4())[:8]        # –î–æ–±–∞–≤–ª—è–µ–º ID –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞        request.state.request_id = request_id        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∏–µ–Ω—Ç–µ        client_ip = self._get_client_ip(request)        user_agent = request.headers.get("user-agent", "Unknown")[:100]        # –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏        start_time = time.perf_counter()        # –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞—á–∞–ª–æ –∑–∞–ø—Ä–æ—Å–∞ (–µ—Å–ª–∏ –Ω–µ –≤ –∏—Å–∫–ª—é—á–µ–Ω–∏—è—Ö)        if request.url.path not in self.exclude_paths:            logger.info(                f"[{request_id}] {request.method} {request.url.path} - "                f"Client: {client_ip} - User-Agent: {user_agent}..."            )        try:            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å            response = await call_next(request)            # –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏            process_time = time.perf_counter() - start_time            # –†–∞–∑–º–µ—Ä –æ—Ç–≤–µ—Ç–∞            content_length = response.headers.get("content-length", "unknown")            # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏            response.headers["X-Request-ID"] = request_id            response.headers["X-Process-Time"] = f"{process_time:.4f}"            # –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞            if request.url.path not in self.exclude_paths:                logger.info(                    f"[{request_id}] {request.method} {request.url.path} - "                    f"Status: {response.status_code} - Time: {process_time:.4f}s - "                    f"Size: {content_length} bytes"                )            return response        except Exception as exc:            # –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ            process_time = time.perf_counter() - start_time            logger.error(                f"[{request_id}] {request.method} {request.url.path} - "                f"ERROR: {str(exc)} - Time: {process_time:.4f}s"            )            # –°–æ–∑–¥–∞–µ–º –æ—Ç–≤–µ—Ç —Å –æ—à–∏–±–∫–æ–π            error_response = JSONResponse(                status_code=500,                content={                    "error": True,                    "message": "Internal server error",                    "request_id": request_id                }            )            error_response.headers["X-Request-ID"] = request_id            error_response.headers["X-Process-Time"] = f"{process_time:.4f}"            return error_response    def _get_client_ip(self, request: Request) -> str:        """–ü–æ–ª—É—á–µ–Ω–∏–µ IP –∞–¥—Ä–µ—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞ —Å —É—á–µ—Ç–æ–º –ø—Ä–æ–∫—Å–∏."""        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –ø—Ä–æ–∫—Å–∏        forwarded_for = request.headers.get("X-Forwarded-For")        if forwarded_for:            return forwarded_for.split(",")[0].strip()        real_ip = request.headers.get("X-Real-IP")        if real_ip:            return real_ip        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º IP –∏–∑ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è        if hasattr(request.client, 'host'):            return request.client.host        return "unknown"class RateLimitMiddleware(BaseHTTPMiddleware):    """    –ë–∞–∑–æ–≤–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.    –ü—Ä–æ—Å—Ç–∞—è –∑–∞—â–∏—Ç–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ IP –∞–¥—Ä–µ—Å–∞ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è    –±–∞–∑–æ–≤—ã—Ö –∞—Ç–∞–∫ –∏ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π.    """    def __init__(self, app, **kwargs):        super().__init__(app, **kwargs)        self.requests = {}  # IP -> {"count": int, "reset_time": float}        self.max_requests = settings.rate_limit_requests        self.window_seconds = settings.rate_limit_window    async def dispatch(self, request: Request, call_next):        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞."""        client_ip = self._get_client_ip(request)        current_time = time.time()        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º health checks        if request.url.path in ["/health", "/metrics"]:            return await call_next(request)        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç—ã        if self._is_rate_limited(client_ip, current_time):            logger.warning(f"Rate limit exceeded for IP: {client_ip}")            return JSONResponse(                status_code=429,                content={                    "error": True,                    "message": "Too many requests",                    "code": "RATE_LIMIT_EXCEEDED"                },                headers={                    "Retry-After": str(self.window_seconds),                    "X-RateLimit-Limit": str(self.max_requests),                    "X-RateLimit-Remaining": "0"                }            )        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫        self._update_counter(client_ip, current_time)        response = await call_next(request)        # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –ª–∏–º–∏—Ç–æ–≤        remaining = self._get_remaining_requests(client_ip, current_time)        response.headers["X-RateLimit-Limit"] = str(self.max_requests)        response.headers["X-RateLimit-Remaining"] = str(remaining)        return response    def _get_client_ip(self, request: Request) -> str:        """–ü–æ–ª—É—á–µ–Ω–∏–µ IP –∞–¥—Ä–µ—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞."""        forwarded_for = request.headers.get("X-Forwarded-For")        if forwarded_for:            return forwarded_for.split(",")[0].strip()        if hasattr(request.client, 'host'):            return request.client.host        return "unknown"    def _is_rate_limited(self, ip: str, current_time: float) -> bool:        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞."""        if ip not in self.requests:            return False        request_data = self.requests[ip]        # –°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞ –µ—Å–ª–∏ –æ–∫–Ω–æ –∏—Å—Ç–µ–∫–ª–æ        if current_time > request_data["reset_time"]:            del self.requests[ip]            return False        return request_data["count"] >= self.max_requests    def _update_counter(self, ip: str, current_time: float):        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤."""        if ip not in self.requests:            self.requests[ip] = {                "count": 1,                "reset_time": current_time + self.window_seconds            }        else:            self.requests[ip]["count"] += 1    def _get_remaining_requests(self, ip: str, current_time: float) -> int:        """–ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Å—Ç–∞–≤—à–µ–≥–æ—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤."""        if ip not in self.requests:            return self.max_requests        request_data = self.requests[ip]        if current_time > request_data["reset_time"]:            return self.max_requests        return max(0, self.max_requests - request_data["count"])def setup_middleware(app: FastAPI) -> None:    """    –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—Å–µ—Ö middleware –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.    Args:        app: –≠–∫–∑–µ–º–ø–ª—è—Ä FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è    """    logger.info("Setting up middleware...")    # 1. CORS - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–≤—ã–º    app.add_middleware(        CORSMiddleware,        allow_origins=settings.cors_origins_list,        allow_credentials=True,        allow_methods=["GET", "POST", "PUT", "DELETE", "OPTIONS", "HEAD", "PATCH"],        allow_headers=[            "Accept",            "Accept-Language",            "Content-Language",            "Content-Type",            "Authorization",            "X-Requested-With",            "X-Request-ID",            "User-Agent",            "Referer"        ],        expose_headers=[            "X-Request-ID",            "X-Process-Time",            "X-RateLimit-Limit",            "X-RateLimit-Remaining"        ]    )    logger.info("‚úÖ CORS middleware configured")    # 2. Security Headers    app.add_middleware(SecurityHeadersMiddleware)    logger.info("‚úÖ Security Headers middleware configured")    # 3. GZip —Å–∂–∞—Ç–∏–µ    app.add_middleware(GZipMiddleware, minimum_size=1000)    logger.info("‚úÖ GZip middleware configured")    # 4. Sessions (–¥–ª—è –≥–æ—Å—Ç–µ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)    app.add_middleware(        SessionMiddleware,        secret_key=settings.secret_key,        max_age=settings.guest_session_expire_hours * 3600,        same_site="lax",        https_only=settings.is_production()    )    logger.info("‚úÖ Session middleware configured")    # 5. Rate Limiting (—Ç–æ–ª—å–∫–æ –≤ production)    if settings.is_production():        app.add_middleware(RateLimitMiddleware)        logger.info("‚úÖ Rate Limiting middleware configured")    # 6. Request Logging    app.add_middleware(RequestLoggingMiddleware)    logger.info("‚úÖ Request Logging middleware configured")    logger.info("üöÄ All middleware configured successfully")def setup_error_handlers(app: FastAPI) -> None:    """    –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –æ—à–∏–±–æ–∫.    Args:        app: –≠–∫–∑–µ–º–ø–ª—è—Ä FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è    """    from app.core.exceptions import setup_exception_handlers    setup_exception_handlers(app)    logger.info("‚úÖ Error handlers configured")